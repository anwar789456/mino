<div class="p-8 w-full">
  <!-- Guard: only render when user is loaded -->
  @if (user) {

  <!-- Profile Header -->
  <div class="bg-gradient-to-r from-[#38a9f3] to-[#56c8ff] rounded-2xl p-6 mb-6 text-white">
    <div class="flex items-center gap-6">
      <div class="w-24 h-24 rounded-full border-4 border-white/30 overflow-hidden bg-white/20 shrink-0">
        <img [src]="user.avatar" [alt]="user.name" class="w-full h-full object-cover" />
      </div>
      <div class="flex-1">
        <h1 class="text-2xl font-bold font-['SN_Pro']">{{ user.name }}</h1>
        <p class="text-white/80 text-sm">{{ user.username }}</p>
        <p class="text-white/70 text-sm mt-1">{{ user.bio }}</p>
        <div class="flex items-center gap-4 mt-3">
          <span class="bg-white/20 px-3 py-1 rounded-full text-xs font-medium">{{ user.level }}</span>
          <span class="text-sm">Joined {{ user.joinDate }}</span>
        </div>
      </div>
      <button (click)="toggleEdit()"
        class="bg-white text-[#38a9f3] px-5 py-2 rounded-lg font-semibold text-sm hover:bg-gray-50 transition-colors shrink-0">
        {{ isEditing ? 'Close' : 'Edit Profile' }}
      </button>
    </div>

    <!-- Edit Profile Form -->
    @if (isEditing) {
    <div class="mt-6 bg-white/10 backdrop-blur-sm rounded-xl p-6 border border-white/20"
      style="animation: slideDown 0.3s ease-out;">
      <h3 class="text-lg font-bold mb-5">Edit Your Profile</h3>
      <div class="flex items-start gap-8">

        <!-- Avatar Upload -->
        <div class="flex flex-col items-center gap-2">
          <div class="relative group cursor-pointer" (click)="avatarInput.click()">
            <div class="w-20 h-20 rounded-full border-3 border-white/40 overflow-hidden bg-white/20">
              <img [src]="avatarPreview || user.avatar" alt="Avatar preview" class="w-full h-full object-cover" />
            </div>
            <div
              class="absolute inset-0 rounded-full bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24"
                stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                <circle cx="12" cy="13" r="3" />
              </svg>
            </div>
          </div>
          <input #avatarInput type="file" accept="image/*" class="hidden" (change)="onAvatarSelected($event)" />
          <span class="text-xs text-white/60">Click to change</span>
        </div>

        <!-- Fields -->
        <div class="flex-1 space-y-4">
          <div>
            <label class="block text-sm text-white/70 mb-1.5 font-medium">Full Name</label>
            <input type="text" [(ngModel)]="editName"
              class="w-full px-4 py-2.5 rounded-lg bg-white/15 border border-white/25 text-white placeholder-white/40 focus:outline-none focus:border-white/50 focus:bg-white/20 transition-all text-sm"
              placeholder="Enter your name" />
          </div>
          <div>
            <label class="block text-sm text-white/70 mb-1.5 font-medium">Username</label>
            <input type="text" [(ngModel)]="editUsername"
              class="w-full px-4 py-2.5 rounded-lg bg-white/15 border border-white/25 text-white placeholder-white/40 focus:outline-none focus:border-white/50 focus:bg-white/20 transition-all text-sm"
              placeholder="Enter your username" />
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex justify-end gap-3 mt-6">
        <button (click)="cancelEdit()" [disabled]="isSaving"
          class="px-5 py-2 rounded-lg border border-white/30 text-white text-sm font-medium hover:bg-white/10 transition-colors disabled:opacity-50">
          Cancel
        </button>
        <button (click)="saveProfile()" [disabled]="isSaving"
          class="px-5 py-2 rounded-lg bg-white text-[#38a9f3] text-sm font-bold hover:bg-gray-100 transition-colors disabled:opacity-50 flex items-center gap-2">
          @if (isSaving) {
          <svg class="animate-spin w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
          </svg>
          Saving...
          } @else {
          Save Changes
          }
        </button>
      </div>
    </div>
    }
  </div>

  <!-- Stats Row -->
  <div class="grid grid-cols-4 gap-4 mb-6">
    @for (stat of stats; track stat.label) {
    <div class="bg-white border border-gray-200 rounded-xl p-4 text-center">
      <p class="text-2xl font-bold text-[#0f1724]">{{ stat.value }}</p>
      <p class="text-sm text-gray-500 mt-1">{{ stat.label }}</p>
    </div>
    }
  </div>

  <div class="flex gap-6">
    <!-- Left Column -->
    <div class="flex-1">
      <!-- Quick Stats -->
      <div class="bg-white border border-gray-200 rounded-xl p-5 mb-6">
        <h2 class="text-lg font-bold text-[#0f1724] font-['SN_Pro'] mb-4">Quick Stats</h2>
        <div class="grid grid-cols-3 gap-4">
          <div class="text-center p-3 bg-[#f0f9ff] rounded-lg">
            <p class="text-2xl font-bold text-[#38a9f3]">{{ user.xp }}</p>
            <p class="text-xs text-gray-500 mt-1">Total XP</p>
          </div>
          <div class="text-center p-3 bg-orange-50 rounded-lg">
            <p class="text-2xl font-bold text-[#f59e0b]">{{ user.streak }}</p>
            <p class="text-xs text-gray-500 mt-1">Day Streak</p>
          </div>
          <div class="text-center p-3 bg-green-50 rounded-lg">
            <p class="text-2xl font-bold text-[#56c416]">{{ user.coins }}</p>
            <p class="text-xs text-gray-500 mt-1">Coins</p>
          </div>
        </div>
      </div>

      <!-- Achievements -->
      <div class="bg-white border border-gray-200 rounded-xl p-5">
        <h2 class="text-lg font-bold text-[#0f1724] font-['SN_Pro'] mb-4">Achievements</h2>
        <div class="grid grid-cols-2 gap-3">
          @for (achievement of achievements; track achievement.title) {
          <div class="flex items-center gap-3 p-3 rounded-lg border" [class.border-gray-200]="achievement.earned"
            [class.bg-white]="achievement.earned" [class.border-gray-100]="!achievement.earned"
            [class.bg-gray-50]="!achievement.earned" [class.opacity-50]="!achievement.earned">
            <div class="w-10 h-10 rounded-full flex items-center justify-center text-lg shrink-0"
              [class.bg-[#e6f6ff]]="achievement.earned" [class.bg-gray-100]="!achievement.earned">
              {{ achievement.icon }}
            </div>
            <div>
              <p class="text-sm font-semibold text-[#0f1724]">{{ achievement.title }}</p>
              <p class="text-xs text-gray-400">{{ achievement.description }}</p>
            </div>
          </div>
          }
        </div>
      </div>
    </div>

    <!-- Right Column -->
    <div class="w-80 shrink-0">
      <!-- Recent Activity -->
      <div class="bg-white border border-gray-200 rounded-xl p-5">
        <h2 class="text-lg font-bold text-[#0f1724] font-['SN_Pro'] mb-4">Recent Activity</h2>
        @for (activity of recentActivity; track activity.action) {
        <div class="flex items-start gap-3 py-3" [class.border-t]="recentActivity.indexOf(activity) > 0"
          [class.border-gray-100]="recentActivity.indexOf(activity) > 0">
          <div class="w-8 h-8 rounded-full bg-[#f0f9ff] flex items-center justify-center text-sm shrink-0">
            {{ activity.icon }}
          </div>
          <div>
            <p class="text-sm text-[#0f1724]">{{ activity.action }}</p>
            <p class="text-xs text-gray-400 mt-0.5">{{ activity.time }}</p>
          </div>
        </div>
        }
      </div>

      <!-- Language -->
      <div class="bg-white border border-gray-200 rounded-xl p-5 mt-4">
        <h2 class="text-lg font-bold text-[#0f1724] font-['SN_Pro'] mb-3">Learning</h2>
        <div class="flex items-center gap-3 p-3 bg-[#f0f9ff] rounded-lg">
          <span class="text-2xl">ðŸ‡¬ðŸ‡§</span>
          <div>
            <p class="text-sm font-semibold text-[#0f1724]">English</p>
            <p class="text-xs text-gray-400">{{ user.level }} Â· {{ user.xp }} XP</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  } @else {
  <!-- Loading state while real user data is being fetched -->
  <div class="flex items-center justify-center h-64">
    <svg class="animate-spin w-8 h-8 text-[#38a9f3]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
    </svg>
    <span class="ml-3 text-gray-500">Loading profile...</span>
  </div>
  }
</div>