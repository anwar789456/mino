<div class="forum-container flex gap-6 p-8 min-h-screen transition-all" [class.forum-dark]="darkMode">
  <!-- Hidden file input -->
  <input type="file" #fileInput class="hidden" accept="image/*,video/*" (change)="onFileSelected($event)" />

  <!-- Notification Toasts -->
  <div class="fixed top-4 right-4 z-[999] flex flex-col gap-2 w-80">
    @for (n of notifications; track n.id) {
      <div class="flex items-center gap-3 px-4 py-3 rounded-xl shadow-lg border backdrop-blur-sm" [class]="n.exiting ? 'toast-exit' : 'toast-enter'" [class.bg-green-50]="n.type === 'success' && !darkMode" [class.border-green-200]="n.type === 'success' && !darkMode" [class.bg-green-900/90]="n.type === 'success' && darkMode" [class.border-green-700]="n.type === 'success' && darkMode" [class.bg-blue-50]="n.type === 'info' && !darkMode" [class.border-blue-200]="n.type === 'info' && !darkMode" [class.bg-blue-900/90]="n.type === 'info' && darkMode" [class.border-blue-700]="n.type === 'info' && darkMode" [class.bg-orange-50]="n.type === 'warning' && !darkMode" [class.border-orange-200]="n.type === 'warning' && !darkMode" [class.bg-orange-900/90]="n.type === 'warning' && darkMode" [class.border-orange-700]="n.type === 'warning' && darkMode">
        <span class="text-lg">{{ getNotifIcon(n.type) }}</span>
        <p class="text-sm flex-1 dm-text" [class.text-gray-700]="!darkMode">{{ n.message }}</p>
        <button (click)="dismissNotification(n.id)" class="text-gray-400 hover:text-gray-600 shrink-0">
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
      </div>
    }
  </div>

  <!-- Main Content -->
  <div class="flex-1">
    <h1 class="text-xl font-bold font-['SN_Pro'] mb-5 dm-text" [class.text-[#0f1724]]="!darkMode">Community</h1>

    <!-- Create Post -->
    <div class="dm-card dm-border rounded-2xl p-5 mb-5 shadow-sm hover:shadow-md transition-shadow" [class.bg-white]="!darkMode" [class.border-gray-200]="!darkMode">
      <div class="flex items-start gap-3 mb-3">
        <div class="w-11 h-11 rounded-full overflow-hidden bg-gradient-to-br from-[#38a9f3] to-[#2196e3] p-[2px] shrink-0">
          <div class="w-full h-full rounded-full overflow-hidden" [class.bg-white]="!darkMode" [class.bg-[#1e293b]]="darkMode">
            @if (user) {
              <img [src]="$any(user).avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + user.name" [alt]="user.name" class="w-full h-full object-cover" />
            }
          </div>
        </div>
        <div class="flex-1 relative user-suggestions-container">
          <textarea #postInput [(ngModel)]="newPostContent" placeholder="What's on your mind? Use #topic or @user to tag..." class="w-full text-sm placeholder-gray-400 outline-none bg-transparent resize-none min-h-[44px] max-h-[120px] leading-relaxed dm-text dm-input" [class.text-[#0f1724]]="!darkMode" (input)="onPostContentInput()" maxlength="1000" rows="2"></textarea>

          <!-- User Suggestions Dropdown -->
          @if (showUserSuggestions && userSuggestions.length > 0) {
            <div class="absolute left-0 top-full mt-1 rounded-xl shadow-xl z-30 w-64 overflow-hidden dm-card dm-border" [class.bg-white]="!darkMode" [class.border-gray-200]="!darkMode">
              @for (u of userSuggestions; track u.username) {
                <button (click)="selectUserTag(u, $event)" class="w-full flex items-center gap-3 px-4 py-2.5 hover:bg-[#f0f7ff] transition-colors text-left dm-hover">
                  <div class="w-8 h-8 rounded-full overflow-hidden bg-gray-200 shrink-0">
                    <img [src]="u.avatar" [alt]="u.name" class="w-full h-full object-cover" />
                  </div>
                  <div class="min-w-0">
                    <p class="text-sm font-semibold dm-text truncate" [class.text-[#0f1724]]="!darkMode">{{ u.name }}</p>
                    <p class="text-xs text-gray-400 dm-text-muted truncate">{{ u.username }}</p>
                  </div>
                </button>
              }
            </div>
          }
        </div>
      </div>

      <!-- Errors -->
      @if (postError) {
        <p class="text-xs text-red-500 mb-2 px-1 flex items-center gap-1">
          <svg class="w-3.5 h-3.5 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" /></svg>
          {{ postError }}
        </p>
      }
      @if (fileError) {
        <p class="text-xs text-red-500 mb-2 px-1 flex items-center gap-1">
          <svg class="w-3.5 h-3.5 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" /></svg>
          {{ fileError }}
        </p>
      }

      <!-- Character counter -->
      @if (newPostContent.length > 0) {
        <div class="flex justify-end mb-2">
          <span class="text-xs font-medium" [class.text-gray-400]="newPostContent.length <= 900" [class.text-orange-400]="newPostContent.length > 900 && newPostContent.length <= 1000" [class.text-red-500]="newPostContent.length > 1000">{{ newPostContent.length }}/1000</span>
        </div>
      }

      <!-- File Preview -->
      @if (filePreviewUrl) {
        <div class="mb-3 relative group">
          @if (fileType === 'image') {
            <div class="rounded-xl overflow-hidden bg-gray-50 border border-gray-100 dm-card-alt">
              <img [src]="filePreviewUrl" alt="Preview" class="w-full max-h-64 object-contain" />
            </div>
          }
          @if (fileType === 'video') {
            <div class="rounded-xl overflow-hidden bg-black border border-gray-100">
              <video [src]="filePreviewUrl" class="w-full max-h-64" controls></video>
            </div>
          }
          <button (click)="removeSelectedFile()" class="absolute top-2 right-2 w-7 h-7 bg-black/60 hover:bg-black/80 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
          @if (selectedFile) {
            <div class="absolute bottom-2 left-2 bg-black/60 text-white text-[10px] px-2 py-0.5 rounded-full font-medium">
              {{ formatFileSize(selectedFile.size) }}
            </div>
          }
        </div>
      }

      <!-- URL image input -->
      @if (showImageInput && !filePreviewUrl) {
        <div class="mb-3">
          <input type="text" [(ngModel)]="newPostImage" placeholder="Paste image URL (https://...)" class="w-full text-sm border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-[#38a9f3]/30 dm-input" [class.border-gray-200]="!darkMode" />
        </div>
      }

      <!-- Location input -->
      @if (showLocationInput) {
        <div class="mb-3 flex items-center gap-2">
          <div class="flex items-center gap-1.5 bg-[#38a9f3]/10 text-[#38a9f3] rounded-lg px-3 py-1.5 flex-1">
            <svg class="w-4 h-4 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" /></svg>
            <input type="text" [(ngModel)]="newPostLocation" placeholder="Add a location (e.g. Paris, France)" class="flex-1 text-sm bg-transparent outline-none placeholder-[#38a9f3]/50 text-[#38a9f3]" maxlength="100" />
          </div>
          <button (click)="toggleLocationInput()" class="text-gray-400 hover:text-gray-600">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
        </div>
      }

      <!-- Location Badge -->
      @if (newPostLocation && !showLocationInput) {
        <div class="mb-3 flex items-center gap-1.5">
          <span class="inline-flex items-center gap-1 bg-[#38a9f3]/10 text-[#38a9f3] text-xs font-medium px-2.5 py-1 rounded-full">
            <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" /></svg>
            {{ newPostLocation }}
          </span>
          <button (click)="newPostLocation = ''" class="text-gray-300 hover:text-gray-500">
            <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
        </div>
      }

      <!-- Emoji Picker -->
      @if (showEmojiPicker) {
        <div class="mb-3 emoji-picker-container rounded-xl shadow-lg overflow-hidden dm-card dm-border" [class.bg-white]="!darkMode" [class.border-gray-200]="!darkMode" (click)="$event.stopPropagation()">
          <div class="flex items-center gap-0.5 px-2 py-1.5 border-b dm-border overflow-x-auto" [class.border-gray-100]="!darkMode">
            @for (cat of emojiCategories; track cat.name; let i = $index) {
              <button (click)="activeEmojiCategory = i; $event.stopPropagation()" class="px-2 py-1 text-lg rounded-lg transition-colors shrink-0" [class.bg-[#38a9f3]/10]="activeEmojiCategory === i" [class.hover:bg-gray-100]="activeEmojiCategory !== i">{{ cat.icon }}</button>
            }
          </div>
          <div class="p-2 h-[180px] overflow-y-auto">
            <div class="flex flex-wrap gap-0.5">
              @for (emoji of emojiCategories[activeEmojiCategory].emojis; track emoji) {
                <button (click)="insertEmoji(emoji, $event)" class="w-8 h-8 flex items-center justify-center text-lg hover:bg-gray-100 rounded-lg transition-colors cursor-pointer">{{ emoji }}</button>
              }
            </div>
          </div>
        </div>
      }

      <!-- GIF Picker -->
      @if (showGifPicker) {
        <div class="mb-3 rounded-xl shadow-lg overflow-hidden dm-card dm-border" [class.bg-white]="!darkMode" [class.border-gray-200]="!darkMode" (click)="$event.stopPropagation()">
          <div class="flex items-center gap-2 px-3 py-2 border-b dm-border" [class.border-gray-100]="!darkMode">
            <span class="text-sm font-bold dm-text" [class.text-[#0f1724]]="!darkMode">GIF</span>
            <input type="text" [(ngModel)]="gifSearchQuery" (input)="onGifSearch()" placeholder="Search GIFs..." class="flex-1 text-sm bg-transparent outline-none gif-search dm-text dm-input" />
            <span class="text-[9px] text-gray-400 font-medium">GIPHY</span>
          </div>
          <div class="p-2 h-[220px] overflow-y-auto">
            @if (gifLoading) {
              <div class="flex items-center justify-center h-full">
                <div class="w-6 h-6 border-2 border-[#38a9f3] border-t-transparent rounded-full animate-spin"></div>
              </div>
            } @else {
              <div class="gif-grid">
                @for (gif of gifResults; track gif.url) {
                  <img [src]="gif.preview || gif.url" (click)="selectGif(gif.url)" alt="GIF" loading="lazy" />
                }
              </div>
              @if (gifResults.length === 0) {
                <p class="text-center text-xs text-gray-400 mt-8">No GIFs found. Try a different search.</p>
              }
            }
          </div>
        </div>
      }

      <!-- Action Bar -->
      <div class="flex items-center justify-between border-t pt-3 dm-border" [class.border-gray-100]="!darkMode">
        <div class="flex items-center gap-1">
          <!-- Media upload -->
          <button (click)="triggerFileInput()" class="p-2 rounded-lg text-gray-400 hover:text-[#38a9f3] hover:bg-[#38a9f3]/10 transition-all" title="Upload image or video">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909M18 3.75H6A2.25 2.25 0 003.75 6v12A2.25 2.25 0 006 20.25h12A2.25 2.25 0 0020.25 18V6A2.25 2.25 0 0018 3.75z" /></svg>
          </button>
          <!-- URL paste -->
          <button (click)="toggleImageInput()" class="p-2 rounded-lg transition-all" [class.text-[#38a9f3]]="showImageInput" [class.bg-[#38a9f3]/10]="showImageInput" [class.text-gray-400]="!showImageInput" title="Paste image URL">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m9.86-2.813a4.5 4.5 0 00-6.364-6.364L4.5 8.25" /></svg>
          </button>
          <!-- GIF -->
          <button (click)="toggleGifPicker($event)" class="p-2 rounded-lg transition-all" [class.text-[#38a9f3]]="showGifPicker" [class.bg-[#38a9f3]/10]="showGifPicker" [class.text-gray-400]="!showGifPicker" title="Add GIF">
            <span class="text-xs font-extrabold tracking-tight">GIF</span>
          </button>
          <!-- Emoji -->
          <button (click)="toggleEmojiPicker($event)" class="emoji-picker-container p-2 rounded-lg transition-all" [class.text-[#38a9f3]]="showEmojiPicker" [class.bg-[#38a9f3]/10]="showEmojiPicker" [class.text-gray-400]="!showEmojiPicker" title="Add emoji">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.182 15.182a4.5 4.5 0 01-6.364 0M21 12a9 9 0 11-18 0 9 9 0 0118 0zM9.75 9.75c0 .414-.168.75-.375.75S9 10.164 9 9.75 9.168 9 9.375 9s.375.336.375.75zm-.375 0h.008v.015h-.008V9.75zm5.625 0c0 .414-.168.75-.375.75s-.375-.336-.375-.75.168-.75.375-.75.375.336.375.75zm-.375 0h.008v.015h-.008V9.75z" /></svg>
          </button>
          <!-- Location -->
          <button (click)="toggleLocationInput()" class="p-2 rounded-lg transition-all" [class.text-[#38a9f3]]="showLocationInput || newPostLocation" [class.bg-[#38a9f3]/10]="showLocationInput || newPostLocation" [class.text-gray-400]="!showLocationInput && !newPostLocation" title="Add location">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" /></svg>
          </button>
        </div>
        <button (click)="createPost()" class="bg-gradient-to-r from-[#38a9f3] to-[#2196e3] text-white px-6 py-2 rounded-xl font-semibold text-sm hover:shadow-lg hover:shadow-[#38a9f3]/25 transition-all active:scale-95">
          Post
        </button>
      </div>
    </div>

    <!-- Topic Filter Indicator -->
    @if (selectedTopicId !== null) {
      <div class="flex items-center gap-2 mb-4 px-1">
        <span class="text-sm text-gray-500">Filtering by topic:</span>
        @for (t of trendingTopics; track t.id) {
          @if (t.id === selectedTopicId) {
            <span class="bg-[#38a9f3]/10 text-[#38a9f3] text-sm font-semibold px-3 py-0.5 rounded-full">{{ t.title }}</span>
          }
        }
        <button (click)="clearTopicFilter()" class="text-xs text-gray-400 hover:text-gray-600 underline">Clear</button>
      </div>
    }

    <!-- Posts -->
    @for (post of filteredPosts; track post.id) {
      <div class="dm-card dm-border rounded-2xl p-5 mb-4 shadow-sm hover:shadow-md transition-shadow" [class.bg-white]="!darkMode" [class.border-gray-200]="!darkMode">
        <div class="flex items-start gap-3 mb-3">
          <div class="w-10 h-10 rounded-full overflow-hidden bg-gray-200 shrink-0">
            <img [src]="post.avatar" [alt]="post.author" class="w-full h-full object-cover" />
          </div>
          <div class="flex-1 min-w-0">
            @if (editingPostId === post.id) {
              <div class="flex flex-col gap-2">
                <textarea [(ngModel)]="editContent" (input)="editError = ''" class="w-full text-sm border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-[#38a9f3]/30 resize-none dm-input" [class.border-gray-200]="!darkMode" rows="3" maxlength="1000"></textarea>
                @if (editError) {
                  <p class="text-xs text-red-500">{{ editError }}</p>
                }
                <div class="flex items-center gap-2">
                  <button (click)="submitEdit(post)" class="bg-[#38a9f3] text-white px-3 py-1 rounded-lg text-xs font-semibold hover:bg-[#2196e3]">Save</button>
                  <button (click)="cancelEdit()" class="bg-gray-100 text-gray-600 px-3 py-1 rounded-lg text-xs font-semibold hover:bg-gray-200">Cancel</button>
                  <span class="text-xs text-gray-400 ml-auto">{{ editContent.length }}/1000</span>
                </div>
              </div>
            } @else {
              <div class="flex items-center gap-2 flex-wrap">
                <span class="text-sm font-bold dm-text" [class.text-[#0f1724]]="!darkMode">{{ post.author }}</span>
                <span class="text-sm text-gray-400 dm-text-muted">{{ post.username }}</span>
                <span class="text-sm text-gray-400 dm-text-muted">¬∑ {{ getTimeAgo(post) }}</span>
                @if (post.isEdited) {
                  <span class="text-[10px] text-gray-400 italic px-1.5 py-0.5 rounded" [class.bg-gray-100]="!darkMode" [class.bg-gray-700]="darkMode">(edited)</span>
                }
              </div>
              <p class="text-sm mt-1.5 leading-relaxed dm-text" [class.text-[#0f1724]]="!darkMode" [innerHTML]="formatContent(post.content)"></p>
            }
          </div>
          <!-- 3-dot menu -->
          <div class="relative">
            <button (click)="toggleMenu(post.id)" class="text-gray-400 hover:text-gray-600 shrink-0 p-1 rounded-lg hover:bg-gray-100 transition-colors dm-hover">
              <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 12a.75.75 0 11-1.5 0 .75.75 0 011.5 0zM12.75 12a.75.75 0 11-1.5 0 .75.75 0 011.5 0zM18.75 12a.75.75 0 11-1.5 0 .75.75 0 011.5 0z" /></svg>
            </button>
            @if (openMenuPostId === post.id) {
              <div class="absolute right-0 top-8 rounded-xl shadow-xl z-10 py-1.5 min-w-[160px] overflow-hidden dm-menu" [class.bg-white]="!darkMode" [class.border]="!darkMode" [class.border-gray-200]="!darkMode">
                @if (isOwnPost(post)) {
                  <button (click)="startEdit(post)" class="w-full text-left px-4 py-2.5 text-sm hover:bg-gray-50 flex items-center gap-2.5 dm-text dm-hover"><svg class="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>Edit</button>
                  <button (click)="deletePost(post)" class="w-full text-left px-4 py-2.5 text-sm text-red-500 hover:bg-red-50 flex items-center gap-2.5"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>Delete</button>
                }
                @if (!isOwnPost(post)) {
                  <button (click)="openReportModal(post)" class="w-full text-left px-4 py-2.5 text-sm text-orange-500 hover:bg-orange-50 flex items-center gap-2.5"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3v1.5M3 21v-6m0 0l2.77-.693a9 9 0 016.208.682l.108.054a9 9 0 006.086.71l3.114-.732a48.524 48.524 0 01-.005-10.499l-3.11.732a9 9 0 01-6.085-.711l-.108-.054a9 9 0 00-6.208-.682L3 4.5M3 15V4.5" /></svg>Report</button>
                }
                <button (click)="openMenuPostId = null" class="w-full text-left px-4 py-2.5 text-sm text-gray-500 hover:bg-gray-50 flex items-center gap-2.5 border-t dm-border dm-hover" [class.border-gray-100]="!darkMode"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>Close</button>
              </div>
            }
          </div>
        </div>

        <!-- Post Image -->
        @if (post.image && !isVideoUrl(post.image)) {
          <div class="rounded-xl overflow-hidden mb-3 max-h-80 flex items-center justify-center" [class.bg-gradient-to-br]="!darkMode" [class.from-blue-50]="!darkMode" [class.to-green-50]="!darkMode" [class.bg-gray-800]="darkMode">
            <img [src]="post.image" alt="Post image" class="max-h-80 w-full object-contain" />
          </div>
        }
        @if (post.image && isVideoUrl(post.image)) {
          <div class="rounded-xl overflow-hidden mb-3 bg-black max-h-80"><video [src]="post.image" class="w-full max-h-80" controls></video></div>
        }
        @if (post.video) {
          <div class="rounded-xl overflow-hidden mb-3 bg-black max-h-80"><video [src]="post.video" class="w-full max-h-80" controls></video></div>
        }

        <!-- Reactions Display -->
        @if (getPostReactions(post.id).length > 0) {
          <div class="flex items-center gap-1 mb-2 flex-wrap">
            @for (r of getPostReactions(post.id); track r.emoji) {
              <span class="inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-full border reaction-pop" [class.bg-[#38a9f3]/10]="getUserReaction(post.id) === r.emoji" [class.border-[#38a9f3]/30]="getUserReaction(post.id) === r.emoji" [class.bg-gray-50]="getUserReaction(post.id) !== r.emoji && !darkMode" [class.border-gray-200]="getUserReaction(post.id) !== r.emoji && !darkMode" [class.bg-gray-700]="getUserReaction(post.id) !== r.emoji && darkMode" [class.border-gray-600]="getUserReaction(post.id) !== r.emoji && darkMode">{{ r.emoji }} <span class="font-semibold dm-text-sec" [class.text-gray-600]="!darkMode">{{ r.count }}</span></span>
            }
          </div>
        }

        <!-- Floating Reaction Animation -->
        @if (floatingReaction?.postId === post.id) {
          <div class="relative h-0">
            <span class="absolute -top-8 left-1/2 -translate-x-1/2 text-2xl reaction-float pointer-events-none">{{ floatingReaction!.emoji }}</span>
          </div>
        }

        <!-- Post Actions -->
        <div class="flex items-center gap-3 text-gray-400 text-sm pt-2.5 border-t dm-border" [class.border-gray-100]="!darkMode">
          <!-- Comment -->
          <button (click)="startReply(post.id)" class="flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg hover:bg-[#38a9f3]/10 hover:text-[#38a9f3] transition-all" [class.text-[#38a9f3]]="replyingToPostId === post.id" [class.bg-[#38a9f3]/10]="replyingToPostId === post.id">
            <svg class="w-[18px] h-[18px]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 20.25c4.97 0 9-3.694 9-8.25s-4.03-8.25-9-8.25S3 7.444 3 12c0 2.104.859 4.023 2.273 5.48.432.447.74 1.04.586 1.641a4.483 4.483 0 01-.923 1.785A5.969 5.969 0 006 21c1.282 0 2.47-.402 3.445-1.087.81.22 1.668.337 2.555.337z" /></svg>
            <span class="text-xs font-medium">{{ post.comments }}</span>
          </button>
          <!-- Repost -->
          <button (click)="repostPost(post)" [disabled]="isOwnPost(post)" class="flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg transition-all" [class.hover:bg-green-50]="!isOwnPost(post)" [class.hover:text-green-500]="!isOwnPost(post)" [class.opacity-40]="isOwnPost(post)" [class.cursor-not-allowed]="isOwnPost(post)" [title]="isOwnPost(post) ? 'You cannot repost your own post' : 'Repost'">
            <svg class="w-[18px] h-[18px]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12c0-1.232-.046-2.453-.138-3.662a4.006 4.006 0 00-3.7-3.7 48.678 48.678 0 00-7.324 0 4.006 4.006 0 00-3.7 3.7c-.017.22-.032.441-.046.662M19.5 12l3-3m-3 3l-3-3m-12 3c0 1.232.046 2.453.138 3.662a4.006 4.006 0 003.7 3.7 48.656 48.656 0 007.324 0 4.006 4.006 0 003.7-3.7c.017-.22.032-.441.046-.662M4.5 12l3 3m-3-3l-3 3" /></svg>
            <span class="text-xs font-medium">{{ post.reposts }}</span>
          </button>
          <!-- React (replaces old Like) -->
          <div class="relative">
            <button (click)="toggleReactionPicker(post.id, $event)" [disabled]="isOwnPost(post)" class="flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg transition-all" [class.hover:bg-red-50]="!isOwnPost(post)" [class.hover:text-red-400]="!isOwnPost(post)" [class.opacity-40]="isOwnPost(post)" [class.cursor-not-allowed]="isOwnPost(post)" [class.text-red-400]="getUserReaction(post.id)" [title]="isOwnPost(post) ? 'You cannot react to your own post' : 'React'">
              @if (getUserReaction(post.id)) {
                <span class="text-base">{{ getUserReaction(post.id) }}</span>
              } @else {
                <svg class="w-[18px] h-[18px]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" /></svg>
              }
              <span class="text-xs font-medium">{{ post.likes }}</span>
            </button>
            <!-- Reaction Picker Popup -->
            @if (showReactionsPostId === post.id) {
              <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 flex items-center gap-0.5 px-2 py-1.5 rounded-full shadow-xl border z-20 dm-card" [class.bg-white]="!darkMode" [class.border-gray-200]="!darkMode" (click)="$event.stopPropagation()">
                @for (emoji of reactionEmojis; track emoji) {
                  <button (click)="reactToPost(post, emoji, $event)" class="w-9 h-9 flex items-center justify-center text-xl rounded-full hover:bg-gray-100 hover:scale-125 transition-all dm-hover" [class.bg-[#38a9f3]/15]="getUserReaction(post.id) === emoji" [class.scale-110]="getUserReaction(post.id) === emoji">{{ emoji }}</button>
                }
              </div>
            }
          </div>
          <!-- Toggle replies -->
          <button (click)="toggleReplies(post)" class="flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg hover:bg-gray-100 hover:text-gray-600 transition-all dm-hover" [class.text-[#38a9f3]]="expandedRepliesPostId === post.id" [class.bg-[#38a9f3]/10]="expandedRepliesPostId === post.id">
            <svg class="w-[18px] h-[18px]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 01.865-.501 48.172 48.172 0 003.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" /></svg>
          </button>
        </div>

        <!-- Reply Input -->
        @if (replyingToPostId === post.id) {
          <div class="mt-3 pt-3 border-t dm-border" [class.border-gray-100]="!darkMode">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 rounded-full overflow-hidden bg-gray-200 shrink-0">
                @if (user) {
                  <img [src]="$any(user).avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + user.name" [alt]="user.name" class="w-full h-full object-cover" />
                }
              </div>
              <input type="text" [(ngModel)]="replyContent" (input)="replyError = ''" placeholder="Write a reply..." class="flex-1 text-sm border rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-[#38a9f3]/20 focus:border-[#38a9f3] dm-input" [class.border-gray-200]="!darkMode" (keydown.enter)="submitReply(post.id)" maxlength="500" />
              <button (click)="submitReply(post.id)" class="bg-[#38a9f3] text-white px-4 py-2 rounded-xl text-xs font-semibold hover:bg-[#2196e3] transition-colors">Reply</button>
              <button (click)="cancelReply()" class="text-gray-400 hover:text-gray-600 text-xs font-medium">Cancel</button>
            </div>
            @if (replyError) {
              <p class="text-xs text-red-500 mt-1 pl-11">{{ replyError }}</p>
            }
          </div>
        }

        <!-- Expanded Replies -->
        @if (expandedRepliesPostId === post.id && repliesMap.get(post.id)) {
          <div class="mt-3 pt-3 border-t dm-border space-y-3" [class.border-gray-100]="!darkMode">
            @for (reply of repliesMap.get(post.id); track reply.id) {
              <div class="flex items-start gap-2 pl-4 border-l-2 border-[#38a9f3]/20">
                <div class="w-7 h-7 rounded-full overflow-hidden bg-gray-200 shrink-0">
                  <img [src]="reply.avatar" [alt]="reply.author" class="w-full h-full object-cover" />
                </div>
                <div class="flex-1">
                  <div class="flex items-center gap-2">
                    <span class="text-xs font-bold dm-text" [class.text-[#0f1724]]="!darkMode">{{ reply.author }}</span>
                    <span class="text-xs text-gray-400 dm-text-muted">{{ reply.username }}</span>
                    <span class="text-xs text-gray-400 dm-text-muted">¬∑ {{ getTimeAgo(reply) }}</span>
                  </div>
                  <p class="text-xs mt-0.5 leading-relaxed dm-text" [class.text-[#0f1724]]="!darkMode" [innerHTML]="formatContent(reply.content)"></p>
                </div>
              </div>
            }
            @if (repliesMap.get(post.id)?.length === 0) {
              <p class="text-xs text-gray-400 pl-4 italic dm-text-muted">No replies yet. Be the first to reply!</p>
            }
          </div>
        }
      </div>
    }

    @if (filteredPosts.length === 0) {
      <div class="text-center py-16 text-gray-400">
        <div class="w-16 h-16 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
          <svg class="w-8 h-8 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 01.865-.501 48.172 48.172 0 003.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" /></svg>
        </div>
        @if (selectedTopicId !== null) {
          <p class="text-sm font-medium text-gray-500">No posts found for this topic.</p>
          <button (click)="clearTopicFilter()" class="text-[#38a9f3] text-sm mt-2 hover:underline font-medium">Show all posts</button>
        } @else {
          <p class="text-sm font-medium text-gray-500">No posts yet.</p>
          <p class="text-xs text-gray-400 mt-1">Be the first to share something!</p>
        }
      </div>
    }
  </div>

  <!-- Right Sidebar -->
  <div class="w-72 shrink-0 flex flex-col gap-4">
    <!-- Dark Mode Toggle -->
    <div class="flex items-center justify-between px-1">
      <span class="text-xs font-semibold dm-text-sec" [class.text-gray-500]="!darkMode">Theme</span>
      <button (click)="toggleDarkMode()" class="relative w-12 h-6 rounded-full transition-colors duration-300 focus:outline-none" [class.bg-[#38a9f3]]="darkMode" [class.bg-gray-300]="!darkMode">
        <div class="absolute top-0.5 w-5 h-5 rounded-full shadow-md flex items-center justify-center text-[10px] transition-transform duration-300" [class.translate-x-6]="darkMode" [class.translate-x-0.5]="!darkMode" [class.bg-[#0f172a]]="darkMode" [class.bg-white]="!darkMode">
          @if (darkMode) { <span>üåô</span> } @else { <span>‚òÄÔ∏è</span> }
        </div>
      </button>
    </div>

    <!-- Search -->
    <div class="relative">
      <svg class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
      </svg>
      <input type="text" [(ngModel)]="searchQuery" (ngModelChange)="onSearchChange()" placeholder="Search Forums" class="w-full pl-9 pr-4 py-2.5 border rounded-full text-sm placeholder-gray-400 outline-none focus:ring-2 focus:ring-[#38a9f3]/30 dm-card dm-input dm-border" [class.bg-white]="!darkMode" [class.border-gray-200]="!darkMode" [class.text-gray-600]="!darkMode" />
    </div>

    <!-- Language/Stats Bar -->
    @if (user) {
      <div class="flex items-center gap-4 text-sm">
        <div class="flex items-center gap-1.5">
          <span class="text-red-400">üè¥</span>
          <span class="font-medium dm-text" [class.text-[#0f1724]]="!darkMode">EN</span>
        </div>
        <div class="flex items-center gap-1.5">
          <span class="text-orange-400">üî•</span>
          <span class="font-medium dm-text" [class.text-[#0f1724]]="!darkMode">{{ $any(user).streak || 0 }}</span>
        </div>
        <div class="flex items-center gap-1.5">
          <span class="text-[#38a9f3]">üíé</span>
          <span class="font-medium dm-text" [class.text-[#0f1724]]="!darkMode">{{ $any(user).xp || 0 }}</span>
        </div>
      </div>
    }

    <!-- New Topic Form -->
    @if (showNewTopicForm) {
      <div class="dm-card dm-border rounded-xl p-4" [class.bg-white]="!darkMode" [class.border-gray-200]="!darkMode">
        <h3 class="text-sm font-bold dm-text mb-3" [class.text-[#0f1724]]="!darkMode">Create New Topic</h3>
        <div class="flex flex-col gap-2">
          <div>
            <input type="text" [(ngModel)]="newTopicTitle" (input)="topicTitleError = ''" placeholder="Topic title (e.g. #PastParticiple)" class="w-full text-sm border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-[#38a9f3]/30" [class.border-red-400]="topicTitleError" [class.border-gray-200]="!topicTitleError" maxlength="50" />
            @if (topicTitleError) {
              <p class="text-xs text-red-500 mt-1">{{ topicTitleError }}</p>
            }
          </div>
          <div>
            <input type="text" [(ngModel)]="newTopicCategory" (input)="topicCategoryError = ''" placeholder="Category (e.g. Grammar)" class="w-full text-sm border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-[#38a9f3]/30" [class.border-red-400]="topicCategoryError" [class.border-gray-200]="!topicCategoryError" maxlength="30" />
            @if (topicCategoryError) {
              <p class="text-xs text-red-500 mt-1">{{ topicCategoryError }}</p>
            }
          </div>
          <div class="flex gap-2">
            <button (click)="createTopic()" class="flex-1 bg-[#38a9f3] text-white py-1.5 rounded-lg text-xs font-semibold hover:bg-[#2196e3]">Create</button>
            <button (click)="toggleNewTopicForm()" class="flex-1 bg-gray-100 text-gray-600 py-1.5 rounded-lg text-xs font-semibold hover:bg-gray-200">Cancel</button>
          </div>
        </div>
      </div>
    }

    <!-- Trending Topics -->
    <div class="dm-card dm-border rounded-xl p-4" [class.bg-white]="!darkMode" [class.border-gray-200]="!darkMode">
      <h3 class="text-base font-bold font-['SN_Pro'] mb-3 dm-text" [class.text-[#0f1724]]="!darkMode">Trending Topics</h3>
      @for (topic of trendingTopics; track topic.id; let i = $index) {
        <div (click)="selectTopic(topic)" class="py-2.5 cursor-pointer -mx-2 px-2 rounded-lg transition-colors dm-hover" [class.border-t]="i > 0" [class.border-gray-100]="i > 0 && !darkMode" [class.border-gray-700]="i > 0 && darkMode" [class.bg-blue-50]="selectedTopicId === topic.id && !darkMode" [class.bg-blue-900/30]="selectedTopicId === topic.id && darkMode">
          <p class="text-xs text-gray-400 dm-text-muted">{{ topic.category }}</p>
          <p class="text-sm font-bold dm-text" [class.text-[#0f1724]]="!darkMode">{{ topic.title }}</p>
          <div class="flex items-center gap-2">
            <p class="text-xs text-gray-400">{{ topic.postCount || 0 }} posts</p>
            <p class="text-xs text-gray-400">{{ topic.viewCount || 0 }} views</p>
          </div>
        </div>
      }
      @if (trendingTopics.length === 0) {
        <p class="text-xs text-gray-400">No trending topics yet.</p>
      }
    </div>

    <!-- Footer -->
    <div class="text-xs text-gray-400 dm-text-muted leading-relaxed">
      Terms of Service ¬∑ Privacy Policy ¬∑ Cookie Policy ¬∑ Accessibility ¬∑ Ads info ¬∑ More ... ¬∑ &copy; 2024 NiNo Inc.
    </div>
  </div>
</div>

<!-- Report Modal -->
@if (showReportModal && reportingPost) {
  <div class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4" (click)="closeReportModal()">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden" (click)="$event.stopPropagation()">
      <!-- Header -->
      <div class="bg-gradient-to-r from-orange-500 to-red-500 px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
            <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 3v1.5M3 21v-6m0 0l2.77-.693a9 9 0 016.208.682l.108.054a9 9 0 006.086.71l3.114-.732a48.524 48.524 0 01-.005-10.499l-3.11.732a9 9 0 01-6.085-.711l-.108-.054a9 9 0 00-6.208-.682L3 4.5M3 15V4.5" />
            </svg>
          </div>
          <div>
            <h3 class="text-white font-bold text-base">Report Post</h3>
            <p class="text-white/70 text-xs">Help us keep the community safe</p>
          </div>
        </div>
        <button (click)="closeReportModal()" class="text-white/80 hover:text-white transition-colors">
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <!-- Reported Post Preview -->
      <div class="px-6 pt-4">
        <p class="text-[10px] uppercase tracking-wider text-gray-400 font-semibold mb-2">Reported Post</p>
        <div class="bg-gray-50 border border-gray-100 rounded-xl p-3 flex items-start gap-3">
          <div class="w-8 h-8 rounded-full overflow-hidden bg-gray-200 shrink-0">
            <img [src]="reportingPost.avatar" [alt]="reportingPost.author" class="w-full h-full object-cover" />
          </div>
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2">
              <span class="text-xs font-bold text-[#0f1724]">{{ reportingPost.author }}</span>
              <span class="text-xs text-gray-400">{{ reportingPost.username }}</span>
            </div>
            <p class="text-xs text-gray-600 mt-0.5 line-clamp-2">{{ reportingPost.content }}</p>
          </div>
        </div>
      </div>

      <!-- Form -->
      <div class="px-6 py-4 space-y-4">
        <div>
          <label class="text-xs font-semibold text-gray-700 mb-1.5 block">Reason for reporting <span class="text-red-500">*</span></label>
          <select [(ngModel)]="reportReason" (change)="reportError = ''" class="w-full text-sm border border-gray-200 rounded-xl px-3 py-2.5 outline-none focus:ring-2 focus:ring-orange-300/40 focus:border-orange-400 bg-white appearance-none cursor-pointer transition-all" [class.border-red-400]="reportError && !reportReason">
            <option value="" disabled>Select a reason...</option>
            @for (reason of reportReasons; track reason) {
              <option [value]="reason">{{ reason }}</option>
            }
          </select>
        </div>
        <div>
          <label class="text-xs font-semibold text-gray-700 mb-1.5 block">Additional details <span class="text-gray-400">(optional)</span></label>
          <textarea [(ngModel)]="reportDescription" placeholder="Provide more context..." class="w-full text-sm border border-gray-200 rounded-xl px-3 py-2.5 outline-none focus:ring-2 focus:ring-orange-300/40 focus:border-orange-400 resize-none transition-all" rows="3" maxlength="500"></textarea>
          <div class="flex justify-end mt-1">
            <span class="text-[10px] text-gray-400">{{ reportDescription.length }}/500</span>
          </div>
        </div>
        @if (reportError) {
          <div class="flex items-center gap-2 bg-red-50 border border-red-200 rounded-xl px-3 py-2">
            <svg class="w-4 h-4 text-red-500 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" /></svg>
            <p class="text-xs text-red-600">{{ reportError }}</p>
          </div>
        }
        @if (reportSuccess) {
          <div class="flex items-center gap-2 bg-green-50 border border-green-200 rounded-xl px-3 py-2">
            <svg class="w-4 h-4 text-green-500 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <p class="text-xs text-green-600">{{ reportSuccess }}</p>
          </div>
        }
      </div>

      <!-- Actions -->
      <div class="px-6 pb-5 flex gap-3">
        <button (click)="closeReportModal()" class="flex-1 bg-gray-100 text-gray-600 py-2.5 rounded-xl text-sm font-semibold hover:bg-gray-200 transition-colors">Cancel</button>
        <button (click)="submitReport()" class="flex-1 bg-gradient-to-r from-orange-500 to-red-500 text-white py-2.5 rounded-xl text-sm font-semibold hover:from-orange-600 hover:to-red-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed" [disabled]="!!reportSuccess">Submit Report</button>
      </div>
    </div>
  </div>
}
